#:include src/widgets/base_screen.kv

<StatusCard@ButtonBehavior+BoxLayout>:
    orientation: 'vertical'
    # Визуальная обратная связь при нажатии
    canvas.before:
        Color:
            rgba: (0.9, 0.9, 0.9, 1) if self.state == 'down' else (1, 1, 1, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(12), dp(12), dp(12), dp(12)]

<FooterButton@ButtonBehavior+BoxLayout>:
    orientation: "vertical"
    spacing: dp(4)
    padding: 0, dp(2), 0, 0
    size_hint: 1, None
    height: dp(64)
    background_color: 0, 0, 0, 0
    canvas.before:
        Color:
            rgba: self.background_color
        Rectangle:
            pos: self.pos
            size: self.size

<FooterLogoButton@ButtonBehavior+AnchorLayout>:
    anchor_x: "center"
    anchor_y: "center"
    background_color: 0, 0, 0, 0
    canvas.before:
        Color:
            rgba: self.background_color
        Rectangle:
            pos: self.pos
            size: self.size

<ProfileScreen>:
    BaseScreen:

        # Body section
        ScrollView:
            id: body_scroll
            size_hint: 1, None
            pos_hint: {"x": 0, "top": 1}
            y: footer.height
            height: root.height - top_bar.height - footer.height if root.height > 0 else dp(400)
            do_scroll_x: False
            do_scroll_y: True
            bar_width: 0
            effect_cls: 'ScrollEffect'
            MDBoxLayout:
                orientation: 'vertical'
                padding: dp(16), dp(12), dp(16), dp(12)
                spacing: dp(20)
                size_hint_y: None
                height: self.minimum_height

                # Отступ сверху для сдвига имени вниз
                Widget:
                    size_hint_y: None
                    height: dp(24)

                # Имя и телефон из БД
                MDBoxLayout:
                    size_hint_y: None
                    height: dp(80)
                    orientation: 'vertical'
                    spacing: dp(4)
                    MDLabel:
                        id: lbl_name
                        text: root.user_name
                        font_size: '28sp'
                        font_style: 'H5'
                        theme_text_color: 'Custom'
                        text_color: 0,0,0,1
                        halign: 'left'
                        valign: 'top'
                        text_size: self.size
                    BoxLayout:
                        size_hint_y: None
                        height: dp(24)
                        MDLabel:
                            id: lbl_phone
                            text: root.user_phone
                            font_size: '16sp'
                            theme_text_color: 'Custom'
                            text_color: 0,0,0,1
                            halign: 'left'
                            valign: 'center'
                            text_size: self.size
                            size_hint_x: 1

                # Виджет 1: Статус карта
                StatusCard:
                    size_hint_y: None
                    height: dp(120)
                    always_release: True
                    on_release: 
                        print('[KV] StatusCard clicked!')
                        app.open_status_overlay()
                    padding: dp(16), dp(12)
                    MDBoxLayout:
                        orientation: 'vertical'
                        spacing: dp(12)
                        # Заголовок
                        MDLabel:
                            text: '5% GOOD FRIENDS'
                            font_size: '18sp'
                            font_style: 'H6'
                            theme_text_color: 'Custom'
                            text_color: 0,0,0,1
                            halign: 'left'
                            valign: 'top'
                            text_size: self.size
                        # Разделительная линия
                        Widget:
                            size_hint_y: None
                            height: dp(1)
                            canvas:
                                Color:
                                    rgba: 0,0,0,1
                                Line:
                                    points: [self.x, self.y + dp(0.5), self.x + self.width, self.y + dp(0.5)]
                                    width: 1
                        # Статус информация
                        BoxLayout:
                            size_hint_y: None
                            height: dp(50)
                            spacing: dp(16)
                            # Левая сторона: Сохранить статус
                            MDBoxLayout:
                                orientation: 'vertical'
                                spacing: dp(4)
                                size_hint_x: 1
                                # Зеленая горизонтальная линия сверху
                                Widget:
                                    size_hint_y: None
                                    height: dp(2)
                                    canvas:
                                        Color:
                                            rgba: 0, 0.8, 0, 1
                                        Rectangle:
                                            pos: self.pos
                                            size: self.size
                                MDLabel:
                                    text: 'Сохранить статус:'
                                    font_size: '12sp'
                                    theme_text_color: 'Custom'
                                    text_color: 0,0,0,1
                                    halign: 'left'
                                    valign: 'top'
                                    text_size: self.size
                                MDLabel:
                                    text: 'Статус сохранен'
                                    font_size: '10sp'
                                    theme_text_color: 'Custom'
                                    text_color: 0.4,0.4,0.4,1
                                    halign: 'left'
                                    valign: 'top'
                                    text_size: self.size
                            # Правая сторона: Повысить статус
                            BoxLayout:
                                orientation: 'horizontal'
                                spacing: dp(4)
                                size_hint_x: None
                                width: dp(140)
                                MDBoxLayout:
                                    orientation: 'vertical'
                                    spacing: dp(4)
                                    MDLabel:
                                        text: 'Повысить статус:'
                                        font_size: '12sp'
                                        theme_text_color: 'Custom'
                                        text_color: 0,0,0,1
                                        halign: 'left'
                                        valign: 'top'
                                        text_size: self.size
                                    MDLabel:
                                        text: '9000 ₽'
                                        font_size: '10sp'
                                        theme_text_color: 'Custom'
                                        text_color: 0.4,0.4,0.4,1
                                        halign: 'left'
                                        valign: 'top'
                                        text_size: self.size
                                MDIcon:
                                    icon: 'arrow-right'
                                    theme_color: 'Custom'
                                    color: 0, 0.8, 0, 1
                                    size_hint: None, None
                                    size: dp(20), dp(20)
                                    valign: 'center'

                # Виджет 2: Карточка подарка (нажатие открывает оверлей)
                StatusCard:
                    size_hint_y: None
                    height: dp(120)
                    always_release: True
                    on_release: app.open_gift_overlay()
                    MDBoxLayout:
                        orientation: 'vertical'
                        spacing: dp(12)
                        # Заголовок
                        BoxLayout:
                            size_hint_y: None
                            height: dp(32)
                            MDLabel:
                                text: '10-й напиток в подарок'
                                font_size: '16sp'
                                font_style: 'H6'
                                theme_text_color: 'Custom'
                                text_color: 0,0,0,1
                                halign: 'left'
                                valign: 'center'
                                text_size: self.size
                                size_hint_x: 1
                            Widget:
                                size_hint_x: None
                                width: dp(8)
                            BoxLayout:
                                orientation: 'horizontal'
                                spacing: dp(4)
                                size_hint_x: None
                                width: dp(100)
                                MDLabel:
                                    text: 'Подробнее'
                                    font_size: '12sp'
                                    theme_text_color: 'Custom'
                                    text_color: 0,0,0,1
                                    halign: 'right'
                                    valign: 'center'
                                    text_size: self.size
                                    size_hint_x: 1
                                MDIcon:
                                    icon: 'arrow-right'
                                    theme_color: 'Custom'
                                    color: 0, 0.8, 0, 1
                                    size_hint: None, None
                                    size: dp(16), dp(16)
                                    valign: 'center'
                        # Прогресс бар с символами чашек
                        BoxLayout:
                            orientation: 'horizontal'
                            size_hint_y: None
                            height: dp(32)
                            spacing: dp(4)
                            # 10 чашек для отслеживания прогресса (изображения)
                            # Первые 9 чашек - купленные напитки (зеленая чашка)
                            Image:
                                source: 'assets/icons/jam_coffee.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            Image:
                                source: 'assets/icons/jam_coffee.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            Image:
                                source: 'assets/icons/jam_coffee.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            Image:
                                source: 'assets/icons/jam_coffee.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            Image:
                                source: 'assets/icons/jam_coffee_gray.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            Image:
                                source: 'assets/icons/jam_coffee_gray.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            Image:
                                source: 'assets/icons/jam_coffee_gray.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            Image:
                                source: 'assets/icons/jam_coffee_gray.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            Image:
                                source: 'assets/icons/jam_coffee_gray.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            # 10-я чашка - подарок (зеленая чашка)
                            Image:
                                source: 'assets/icons/jam_coffee_gray.png'
                                size_hint_x: None
                                width: dp(20)
                                height: dp(24)
                                allow_stretch: True
                                keep_ratio: True
                            # Заполнитель для выравнивания слева
                            Widget:
                                size_hint_x: 1

        # Footer section (навигационный бар из main.py)
        BoxLayout:
            id: footer
            size_hint_x: 1
            size_hint_y: None
            height: dp(88)
            pos_hint: {"x": 0, "y": 0}
            padding: dp(12), dp(8)
            spacing: dp(12)
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                Rectangle:
                    source: "assets/backgrounds/Footer.jpg"
                    pos: self.pos
                    size: self.size
            FooterButton:
                on_release: app.footer_addresses_click()
                AnchorLayout:
                    anchor_x: "center"
                    anchor_y: "center"
                    MDIcon:
                        icon: "map-marker"
                        size_hint: None, None
                        width: dp(24)
                        height: dp(24)
                        theme_color: "Custom"
                        color: 0, 0, 0, 1
                AnchorLayout:
                    anchor_x: "center"
                    anchor_y: "center"
                    Label:
                        text: "Наши кофейни"
                        font_size: "12sp"
                        halign: "center"
                        valign: "middle"
                        text_size: self.size
                        color: 0, 0, 0, 1
            FooterLogoButton:
                on_release: app.open_loyalty_overlay()
                Image:
                    source: "assets/icons/Logo.jpg"
                    size_hint: None, None
                    width: dp(64)
                    height: dp(64)
                    allow_stretch: True
                    keep_ratio: True
            FooterButton:
                on_release: app.footer_invite_click()
                AnchorLayout:
                    anchor_x: "center"
                    anchor_y: "center"
                    MDIcon:
                        icon: "account-plus"
                        size_hint: None, None
                        width: dp(24)
                        height: dp(24)
                        theme_color: "Custom"
                        color: 0, 0, 0, 1
                AnchorLayout:
                    anchor_x: "center"
                    anchor_y: "center"
                    Label:
                        text: "Пригласить"
                        font_size: "12sp"
                        halign: "center"
                        valign: "middle"
                        text_size: self.size
                        color: 0, 0, 0, 1

        # TopBar section (placed last so it stays on top and receives touches)
        BoxLayout:
            id: top_bar
            size_hint_x: 1
            size_hint_y: None
            height: dp(56)
            pos_hint: {"x": 0, "top": 1}
            padding: dp(12), 0
            # Кнопка назад
            AnchorLayout:
                anchor_x: 'left'
                anchor_y: 'center'
                size_hint_x: None
                width: dp(48)
                MDIconButton:
                    icon: 'chevron-left'
                    theme_text_color: 'Custom'
                    text_color: 0,0,0,1
                    size_hint: None, None
                    size: dp(48), dp(48)
                    on_press: print('[KV] Back button pressed!')
                    on_release: app.go_back()
            # Надпись Профиль
            AnchorLayout:
                anchor_x: 'center'
                anchor_y: 'center'
                MDLabel:
                    text: 'Профиль'
                    halign: 'center'
                    valign: 'middle'
                    theme_text_color: 'Custom'
                    text_color: 0,0,0,1
            # Кнопка выхода
            AnchorLayout:
                anchor_x: 'right'
                anchor_y: 'center'
                size_hint_x: None
                width: dp(48)
                MDIconButton:
                    icon: 'exit-to-app'
                    theme_text_color: 'Custom'
                    text_color: 0,0,0,1
                    on_release: app.profile_logout()

        # Loyalty overlay (центрированный оверлей с кодом программы лояльности)
        FloatLayout:
            id: loyalty_overlay_root
            size_hint: None, None
            size: 0, 0
            opacity: 0
            disabled: True
            Button:
                background_color: 0, 0, 0, 0.5
                size_hint: 1, 1
                disabled: self.parent.disabled
                on_release: app.close_loyalty_overlay()
            # Панель оверлея, выезжает снизу и занимает 80% высоты
            BoxLayout:
                id: loyalty_panel
                orientation: "vertical"
                size_hint_x: 1
                size_hint_y: None
                height: self.parent.height * 0.8 if self.parent else 0
                y: -self.height
                MDCard:
                    size_hint: 1, 1
                    radius: [16, 16, 0, 0]
                    md_bg_color: 1, 1, 1, 1
                    elevation: 8
                    padding: 0, 0, 0, 0
                    orientation: "vertical"
                    # Вкладки
                    BoxLayout:
                        size_hint_y: None
                        height: dp(48)
                        orientation: "horizontal"
                        padding: dp(16), 0, dp(16), 0
                        spacing: dp(24)
                        # Вкладка "Все"
                        BoxLayout:
                            orientation: "vertical"
                            size_hint_x: None
                            width: dp(80)
                            spacing: 0
                            MDLabel:
                                text: "Все"
                                font_name: "assets/fonts/minecraft.ttf"
                                font_size: "14sp"
                                halign: "center"
                                valign: "middle"
                                theme_text_color: "Custom"
                                text_color: 0, 0, 0, 1
                                size_hint_y: 1
                            # Зеленая полоса под выбранной вкладкой
                            Widget:
                                size_hint_y: None
                                height: dp(3)
                                canvas:
                                    Color:
                                        rgba: 0.2, 0.8, 0.4, 1
                                    Rectangle:
                                        pos: self.pos
                                        size: self.size
                        # Вкладка "Мои бонусы"
                        BoxLayout:
                            orientation: "vertical"
                            size_hint_x: None
                            width: dp(120)
                            spacing: 0
                            MDLabel:
                                text: "Мои бонусы"
                                font_name: "assets/fonts/minecraft.ttf"
                                font_size: "14sp"
                                halign: "center"
                                valign: "middle"
                                theme_text_color: "Custom"
                                text_color: 0.5, 0.5, 0.5, 1
                                size_hint_y: 1
                            Widget:
                                size_hint_y: None
                                height: dp(3)
                    
                    # Прокручиваемый контент
                    ScrollView:
                        size_hint_y: 1
                        do_scroll_x: False
                        do_scroll_y: True
                        bar_width: 0
                        effect_cls: "ScrollEffect"
                        MDBoxLayout:
                            orientation: "vertical"
                            spacing: dp(24)
                            size_hint_y: None
                            height: self.minimum_height
                            padding: dp(24), dp(24), dp(24), dp(24)
                            
                            # Текст инструкции
                            MDBoxLayout:
                                orientation: "vertical"
                                spacing: dp(4)
                                size_hint_y: None
                                height: self.minimum_height
                                MDLabel:
                                    text: "Назовите код бариста."
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "center"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "Так мы сможем"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "center"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "идентифицировать вас в"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "center"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "программе лояльности,"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "center"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "чтобы начислить или"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "center"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "списать изумруды"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "center"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                            
                            # Большой код
                            MDLabel:
                                id: loyalty_code_label
                                text: "13037"
                                font_name: "assets/fonts/minecraft.ttf"
                                font_size: "48sp"
                                halign: "center"
                                valign: "middle"
                                theme_text_color: "Custom"
                                text_color: 0, 0, 0, 1
                                size_hint_y: None
                                height: dp(60)
                            
                            # Штрих-код
                            AnchorLayout:
                                anchor_x: "center"
                                anchor_y: "center"
                                size_hint_y: None
                                height: dp(120)
                                Image:
                                    source: "assets/icons/сode.jpg"
                                    size_hint: None, None
                                    width: dp(280)
                                    height: dp(120)
                                    allow_stretch: True
                                    keep_ratio: True
                            
                            # Повтор кода под штрих-кодом
                            MDLabel:
                                id: loyalty_code_label_small
                                text: "13037"
                                font_name: "assets/fonts/minecraft.ttf"
                                font_size: "18sp"
                                halign: "center"
                                valign: "middle"
                                theme_text_color: "Custom"
                                text_color: 0, 0, 0, 1
                                size_hint_y: None
                                height: dp(30)
                    
                    # Кнопка закрыть (зеленая, внизу)
                    BoxLayout:
                        size_hint_y: None
                        height: dp(56) + dp(32)
                        padding: dp(16), dp(16), dp(16), dp(16)
                        Button:
                            size_hint: 1, 1
                            background_color: 0, 0, 0, 0
                            on_release: app.close_loyalty_overlay()
                            text: "Закрыть"
                            font_name: "assets/fonts/minecraft.ttf"
                            font_size: "16sp"
                            color: 1, 1, 1, 1
                            canvas.before:
                                Color:
                                    rgba: 0.2, 0.8, 0.4, 1
                                RoundedRectangle:
                                    pos: self.pos
                                    size: self.size
                                    radius: [dp(12), dp(12), dp(12), dp(12)]

        # Status overlay (оверлей информации о статусах)
        FloatLayout:
            id: status_overlay_root
            size_hint: None, None
            size: 0, 0
            opacity: 0
            disabled: True
            Button:
                background_color: 0, 0, 0, 0.5
                size_hint: 1, 1
                disabled: self.parent.disabled
                on_release: app.close_status_overlay()
            # Панель оверлея, выезжает снизу и занимает 80% высоты
            BoxLayout:
                id: status_panel
                orientation: "vertical"
                size_hint_x: 1
                size_hint_y: None
                height: self.parent.height * 0.8 if self.parent else 0
                y: -self.height
                MDCard:
                    size_hint: 1, 1
                    radius: [16, 16, 0, 0]
                    md_bg_color: 1, 1, 1, 1
                    elevation: 8
                    padding: dp(24), dp(24), dp(24), dp(24)
                    orientation: "vertical"
                    
                    # Заголовок
                    MDLabel:
                        text: "Как прокачать свой статус?"
                        font_name: "assets/fonts/minecraft.ttf"
                        font_size: "18sp"
                        halign: "center"
                        valign: "middle"
                        theme_text_color: "Custom"
                        text_color: 0, 0, 0, 1
                        size_hint_y: None
                        height: dp(40)
                    
                    # Вертикальная прогресс-бар со статусами
                    BoxLayout:
                        orientation: "horizontal"
                        size_hint_y: None
                        height: dp(280)
                        spacing: dp(16)
                        padding: dp(16), 0
                        
                        # Левая часть - иконки и линии
                        BoxLayout:
                            orientation: "vertical"
                            size_hint_x: None
                            width: dp(40)
                            spacing: 0
                            
                            # Friend - зеленый круг
                            Widget:
                                size_hint_y: None
                                height: dp(40)
                                canvas:
                                    Color:
                                        rgba: 0.2, 0.8, 0.4, 1
                                    Ellipse:
                                        pos: self.x + self.width/2 - dp(8), self.y + self.height/2 - dp(8)
                                        size: dp(16), dp(16)
                            
                            # Зеленая линия до Good Friend
                            Widget:
                                size_hint_y: None
                                height: dp(60)
                                canvas:
                                    Color:
                                        rgba: 0.2, 0.8, 0.4, 1
                                    Line:
                                        points: [self.x + self.width/2, self.y, self.x + self.width/2, self.y + self.height]
                                        width: dp(3)
                            
                            # Good Friend - коричневый квадрат
                            Widget:
                                size_hint_y: None
                                height: dp(40)
                                canvas:
                                    Color:
                                        rgba: 0.4, 0.2, 0.1, 1
                                    Rectangle:
                                        pos: self.x + self.width/2 - dp(8), self.y + self.height/2 - dp(8)
                                        size: dp(16), dp(16)
                            
                            # Серая линия до Best Friend
                            Widget:
                                size_hint_y: None
                                height: dp(60)
                                canvas:
                                    Color:
                                        rgba: 0.5, 0.5, 0.5, 1
                                    Line:
                                        points: [self.x + self.width/2, self.y, self.x + self.width/2, self.y + self.height]
                                        width: dp(3)
                            
                            # Best Friend - серый круг
                            Widget:
                                size_hint_y: None
                                height: dp(40)
                                canvas:
                                    Color:
                                        rgba: 0.5, 0.5, 0.5, 1
                                    Ellipse:
                                        pos: self.x + self.width/2 - dp(8), self.y + self.height/2 - dp(8)
                                        size: dp(16), dp(16)
                            
                            # Серая линия до Old Friend
                            Widget:
                                size_hint_y: None
                                height: dp(60)
                                canvas:
                                    Color:
                                        rgba: 0.5, 0.5, 0.5, 1
                                    Line:
                                        points: [self.x + self.width/2, self.y, self.x + self.width/2, self.y + self.height]
                                        width: dp(3)
                            
                            # Old Friend - серый круг
                            Widget:
                                size_hint_y: None
                                height: dp(40)
                                canvas:
                                    Color:
                                        rgba: 0.5, 0.5, 0.5, 1
                                    Ellipse:
                                        pos: self.x + self.width/2 - dp(8), self.y + self.height/2 - dp(8)
                                        size: dp(16), dp(16)
                        
                        # Правая часть - названия статусов и суммы
                        MDBoxLayout:
                            orientation: "vertical"
                            spacing: 0
                            
                            # Friend
                            MDBoxLayout:
                                orientation: "vertical"
                                size_hint_y: None
                                height: dp(40)
                                spacing: dp(4)
                                MDLabel:
                                    text: "Friend"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "left"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "от 0 р"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "12sp"
                                    halign: "left"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0.5, 0.5, 0.5, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                            
                            Widget:
                                size_hint_y: None
                                height: dp(60)
                            
                            # Good Friend
                            MDBoxLayout:
                                orientation: "vertical"
                                size_hint_y: None
                                height: dp(40)
                                spacing: dp(4)
                                MDLabel:
                                    text: "Good Friend"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "left"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "от 2000 р"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "12sp"
                                    halign: "left"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0.5, 0.5, 0.5, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                            
                            Widget:
                                size_hint_y: None
                                height: dp(60)
                            
                            # Best Friend
                            MDBoxLayout:
                                orientation: "vertical"
                                size_hint_y: None
                                height: dp(40)
                                spacing: dp(4)
                                MDLabel:
                                    text: "Best Friend"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "left"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "от 9000 р"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "12sp"
                                    halign: "left"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0.5, 0.5, 0.5, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                            
                            Widget:
                                size_hint_y: None
                                height: dp(60)
                            
                            # Old Friend
                            MDBoxLayout:
                                orientation: "vertical"
                                size_hint_y: None
                                height: dp(40)
                                spacing: dp(4)
                                MDLabel:
                                    text: "Old Friend"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "14sp"
                                    halign: "left"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0, 0, 0, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                                MDLabel:
                                    text: "от 18 000 р"
                                    font_name: "assets/fonts/minecraft.ttf"
                                    font_size: "12sp"
                                    halign: "left"
                                    valign: "middle"
                                    theme_text_color: "Custom"
                                    text_color: 0.5, 0.5, 0.5, 1
                                    size_hint_y: None
                                    height: self.texture_size[1]
                    
                    # Текст объяснения
                    MDLabel:
                        text: "Переход между статусами зависит от суммы покупок, которые ты совершаешь. Суммы между статусами не суммируются, и после перехода отсчет начинается с нуля"
                        font_name: "assets/fonts/minecraft.ttf"
                        font_size: "12sp"
                        halign: "left"
                        valign: "top"
                        theme_text_color: "Custom"
                        text_color: 0, 0, 0, 1
                        size_hint_y: None
                        height: self.texture_size[1]
                        text_size: self.width, None
                    
                    Widget:
                        size_hint_y: None
                        height: dp(16)
                    
                    # Кнопка закрыть (зеленая, внизу)
                    BoxLayout:
                        size_hint_y: None
                        height: dp(56)
                        padding: 0, 0, 0, 0
                        Button:
                            size_hint: 1, 1
                            background_color: 0, 0, 0, 0
                            on_release: app.close_status_overlay()
                            text: "Закрыть"
                            font_name: "assets/fonts/minecraft.ttf"
                            font_size: "16sp"
                            color: 1, 1, 1, 1
                            canvas.before:
                                Color:
                                    rgba: 0.2, 0.8, 0.4, 1
                                RoundedRectangle:
                                    pos: self.pos
                                    size: self.size
                                    radius: [dp(12), dp(12), dp(12), dp(12)]

        # Gift overlay (оверлей для "10-й напиток в подарок"), схема как у статусного оверлея
        FloatLayout:
            id: gift_overlay_root
            size_hint: None, None
            size: 0, 0
            opacity: 0
            disabled: True
            Button:
                background_color: 0, 0, 0, 0.5
                size_hint: 1, 1
                disabled: self.parent.disabled
                on_release: app.close_gift_overlay()
            # Панель оверлея, выезжает снизу и занимает 80% высоты
            BoxLayout:
                id: gift_panel
                orientation: "vertical"
                size_hint_x: 1
                size_hint_y: None
                height: self.parent.height * 0.8 if self.parent else 0
                y: -self.height
                MDCard:
                    size_hint: 1, 1
                    radius: [16, 16, 0, 0]
                    md_bg_color: 1, 1, 1, 1
                    elevation: 8
                    padding: dp(24), dp(24), dp(24), dp(16)
                    orientation: "vertical"

                    # Заголовок
                    MDLabel:
                        text: "10-й напиток в подарок"
                        font_name: "assets/fonts/minecraft.ttf"
                        font_size: "20sp"
                        halign: "center"
                        valign: "middle"
                        theme_text_color: "Custom"
                        text_color: 0, 0, 0, 1
                        size_hint_y: None
                        height: dp(36)

                    # Прокручиваемый контент
                    ScrollView:
                        size_hint_y: 1
                        do_scroll_x: False
                        do_scroll_y: True
                        bar_width: 0
                        effect_cls: "ScrollEffect"
                        MDBoxLayout:
                            orientation: "vertical"
                            spacing: dp(20)
                            size_hint_y: None
                            height: self.minimum_height

                            # Карточка с прогрессом (как на макете)
                            MDCard:
                                size_hint_y: None
                                height: dp(160)
                                radius: [16, 16, 16, 16]
                                md_bg_color: 0.97, 0.97, 0.97, 1
                                elevation: 0
                                padding: dp(16), dp(16)
                                MDBoxLayout:
                                    orientation: "vertical"
                                    spacing: dp(12)

                                    BoxLayout:
                                        size_hint_y: None
                                        height: dp(28)
                                        MDLabel:
                                            text: "10-й напиток в подарок"
                                            font_name: "assets/fonts/minecraft.ttf"
                                            font_size: "16sp"
                                            halign: "left"
                                            valign: "middle"
                                            theme_text_color: "Custom"
                                            text_color: 0, 0, 0, 1
                                            size_hint_x: 1
                                            text_size: self.size
                                        MDLabel:
                                            text: "Кофейни"
                                            font_name: "assets/fonts/minecraft.ttf"
                                            font_size: "14sp"
                                            halign: "right"
                                            valign: "middle"
                                            theme_text_color: "Custom"
                                            text_color: 0, 0, 0, 1
                                            size_hint_x: None
                                            width: dp(80)
                                        MDIcon:
                                            icon: "send"
                                            theme_text_color: "Custom"
                                            text_color: 0, 0, 0, 1
                                            size_hint: None, None
                                            size: dp(18), dp(18)

                                    BoxLayout:
                                        orientation: "horizontal"
                                        size_hint_y: None
                                        height: dp(48)
                                        spacing: dp(6)
                                        padding: 0, dp(6), 0, 0

                                        # 10 чашек (5 заполненных, 5 пустых)
                                        Image:
                                            source: 'assets/icons/jam_coffee.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee_gray.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee_gray.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee_gray.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee_gray.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True
                                        Image:
                                            source: 'assets/icons/jam_coffee_gray.png'
                                            size_hint: None, None
                                            size: dp(24), dp(24)
                                            allow_stretch: True
                                            keep_ratio: True

                                    Widget:
                                        size_hint_y: None
                                        height: dp(4)

                            # Текстовые правила
                            MDLabel:
                                text: "В акции участвуют только большие стаканы (объемом 600 мл).\nКаждый набор напитков появляется в приложении у каждого покупателя. Изумруды за покупку напитка по акции не начисляются. На кассе не забудь сказать, что хочешь забрать свой подарочный напиток!\nАкция действует всегда и во всех кофейнях."
                                font_name: "assets/fonts/minecraft.ttf"
                                font_size: "14sp"
                                halign: "left"
                                valign: "top"
                                theme_text_color: "Custom"
                                text_color: 0, 0, 0, 1
                                size_hint_y: None
                                text_size: self.width, None
                                height: self.texture_size[1]

                    # Кнопка закрыть (как в статусном оверлее)
                    BoxLayout:
                        size_hint_y: None
                        height: dp(56)
                        padding: 0, 0, 0, 0
                        Button:
                            size_hint: 1, 1
                            background_color: 0, 0, 0, 0
                            on_release: app.close_gift_overlay()
                            text: "Закрыть"
                            font_name: "assets/fonts/minecraft.ttf"
                            font_size: "16sp"
                            color: 1, 1, 1, 1
                            canvas.before:
                                Color:
                                    rgba: 0.2, 0.8, 0.4, 1
                                RoundedRectangle:
                                    pos: self.pos
                                    size: self.size
                                    radius: [dp(12), dp(12), dp(12), dp(12)]

